<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÏÇºÍµ≠ÏßÄ Îü¨Ïâ¨ Ïò§Î¶¨ÏßÑ3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: #1a1a2e;
            color: white;
            overflow: hidden;
            margin: 0;
            padding: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* ÏÉÅÎã® Ìó§Îçî (ÌÅ¥ÎûòÏãúÏò§Î∏åÌÅ¥Îûú Ïä§ÌÉÄÏùº) */
        #topHeader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: clamp(50px, 8vh, 70px);
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 clamp(10px, 2vw, 15px);
            z-index: 200;
            pointer-events: none;
        }
        
        #topUI {
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 15px);
            flex: 1;
            pointer-events: none;
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            gap: clamp(4px, 1vw, 8px);
            background: rgba(0, 0, 0, 0.5);
            padding: clamp(6px, 1.5vh, 10px) clamp(10px, 2.5vw, 15px);
            border-radius: clamp(15px, 3vh, 25px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: clamp(12px, 2.5vw, 16px);
            font-weight: bold;
            min-height: clamp(32px, 5vh, 40px);
        }
        
        .resource-icon {
            font-size: clamp(16px, 3.5vw, 22px);
        }
        
        #gold {
            color: #ffd700;
        }
        
        #treasure {
            color: #9370db;
        }
        
        #round {
            color: #87ceeb;
        }
        
        #topButtons {
            display: flex;
            gap: clamp(6px, 1.5vw, 10px);
            pointer-events: none;
        }
        
        .ui-btn {
            padding: clamp(8px, 1.5vh, 12px) clamp(12px, 3vw, 18px);
            background: rgba(65, 105, 225, 0.9);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: clamp(12px, 2.5vh, 20px);
            cursor: pointer;
            font-size: clamp(11px, 2.5vw, 14px);
            pointer-events: auto;
            min-height: clamp(32px, 5vh, 40px);
            min-width: clamp(50px, 12vw, 70px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            touch-action: manipulation;
            white-space: nowrap;
        }
        
        .ui-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        
        #shopButton {
            background: rgba(65, 105, 225, 0.9);
        }
        
        #heroManageButton {
            background: rgba(50, 205, 50, 0.9);
        }
        
        /* Í≤åÏûÑ Ï∫îÎ≤ÑÏä§ (Ï§ëÏïô ÏòÅÏó≠) */
        #gameCanvas {
            display: block;
            background: #0f3460;
            width: 100%;
            height: 100%;
            object-fit: contain;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            margin-top: clamp(50px, 8vh, 70px);
            margin-bottom: clamp(80px, 12vh, 120px);
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        /* ÌïòÎã® ÏòÅÏõÖ ÏÑ†ÌÉù Î∞î (ÌÅ¥ÎûòÏãúÏò§Î∏åÌÅ¥Îûú Ïä§ÌÉÄÏùº) */
        #heroSelection {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: clamp(80px, 12vh, 120px);
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7));
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 12px);
            padding: clamp(8px, 1.5vh, 12px) clamp(10px, 2vw, 15px);
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            pointer-events: auto;
            z-index: 200;
        }
        
        #heroSelection::-webkit-scrollbar {
            height: 4px;
        }
        
        #heroSelection::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        
        .hero-btn {
            flex-shrink: 0;
            width: clamp(60px, 12vw, 80px);
            height: clamp(60px, 12vw, 80px);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: clamp(10px, 2vh, 15px);
            cursor: pointer;
            font-size: clamp(10px, 2vw, 12px);
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        }
        
        .hero-btn:active {
            transform: scale(0.9);
        }
        
        .hero-btn.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.4);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }
        
        .hero-btn-name {
            font-weight: bold;
            margin-bottom: 2px;
            text-align: center;
            line-height: 1.1;
        }
        
        .hero-btn-count {
            font-size: clamp(9px, 1.8vw, 11px);
            color: #ccc;
            margin-top: 2px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            pointer-events: auto;
        }
        
        .modal.show {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(10px, 2vw, 20px);
        }
        
        .modal-content {
            background: rgba(30, 30, 50, 0.98);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: clamp(15px, 3vw, 25px);
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        
        .modal-title {
            font-size: clamp(20px, 5vw, 32px);
            margin-bottom: clamp(15px, 3vh, 25px);
            text-align: center;
            color: #ffd700;
        }
        
        .close-btn {
            position: absolute;
            top: clamp(10px, 2vh, 15px);
            right: clamp(10px, 2vw, 15px);
            padding: clamp(10px, 2vh, 14px) clamp(20px, 4vw, 28px);
            background: #dc143c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 18px);
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .close-btn:active {
            transform: scale(0.95);
        }
        
        .gacha-section {
            text-align: center;
        }
        
        .gacha-buttons {
            display: flex;
            flex-direction: column;
            gap: clamp(10px, 2vh, 15px);
            margin: clamp(15px, 3vh, 25px) 0;
        }
        
        .gacha-btn {
            padding: clamp(14px, 3vh, 20px) clamp(20px, 5vw, 30px);
            font-size: clamp(16px, 4vw, 22px);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            min-height: 60px;
            touch-action: manipulation;
        }
        
        .gacha-btn:active {
            transform: scale(0.95);
        }
        
        .gacha-btn.single {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gacha-btn.multi {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .hero-card {
            display: inline-block;
            width: clamp(100px, 20vw, 140px);
            height: clamp(140px, 28vw, 200px);
            margin: clamp(5px, 1vw, 10px);
            padding: clamp(8px, 1.5vw, 12px);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: center;
            border: 3px solid;
            transition: transform 0.2s;
        }
        
        .hero-card:active {
            transform: scale(0.95);
        }
        
        .hero-card.normal {
            border-color: #808080;
        }
        
        .hero-card.rare {
            border-color: #4169e1;
        }
        
        .hero-card.sr {
            border-color: #9370db;
        }
        
        .hero-card.ssr {
            border-color: #ffd700;
        }
        
        .gacha-result {
            margin-top: clamp(15px, 3vh, 25px);
            padding: clamp(10px, 2vw, 20px);
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            display: none;
        }
        
        .gacha-result.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .gacha-buttons {
                flex-direction: column;
            }
            
            .gacha-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- ÏÉÅÎã® Ìó§Îçî (ÌÅ¥ÎûòÏãúÏò§Î∏åÌÅ¥Îûú Ïä§ÌÉÄÏùº) -->
        <div id="topHeader">
            <div id="topUI">
                <div class="resource-item" id="gold">
                    <span class="resource-icon">üí∞</span>
                    <span id="goldAmount">1000</span>
                </div>
                <div class="resource-item" id="treasure">
                    <span class="resource-icon">üíé</span>
                    <span id="treasureAmount">10</span>
                </div>
                <div class="resource-item" id="round">
                    <span class="resource-icon">‚öîÔ∏è</span>
                    <span id="roundNumber">1</span>
                </div>
            </div>
            <div id="topButtons">
                <button id="shopButton" class="ui-btn">ÏÉÅÏ†ê</button>
                <button id="heroManageButton" class="ui-btn">ÏòÅÏõÖ</button>
            </div>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui">
            <!-- ÌïòÎã® ÏòÅÏõÖ ÏÑ†ÌÉù Î∞î -->
            <div id="heroSelection"></div>
        </div>
    </div>
    
    <!-- ÏÉÅÏ†ê Î™®Îã¨ -->
    <div id="shopModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('shopModal')">Îã´Í∏∞</button>
            <h2 class="modal-title">ÏÉÅÏ†ê</h2>
            <div class="gacha-section">
                <h3 style="margin-bottom: 15px; font-size: clamp(18px, 4vw, 24px);">ÏòÅÏõÖ ÏÜåÌôò</h3>
                <div class="gacha-buttons">
                    <button class="gacha-btn single" onclick="gachaSingle()">
                        Ïã±Í∏Ä ÎΩëÍ∏∞<br>
                        <small>Í∏àÌôî 1000</small>
                    </button>
                    <button class="gacha-btn multi" onclick="gachaMulti()">
                        10Ïó∞ÏÜç ÎΩëÍ∏∞<br>
                        <small>Í∏àÌôî 9000</small>
                    </button>
                    <button class="gacha-btn single" onclick="gachaSingleTreasure()">
                        Í≥†Í∏â ÎΩëÍ∏∞<br>
                        <small>Î≥¥Î¨º 10</small>
                    </button>
                    <button class="gacha-btn multi" onclick="gachaMultiTreasure()">
                        Ï†ÑÏÑ§ 10Ïó∞ÏÜç<br>
                        <small>Î≥¥Î¨º 90</small>
                    </button>
                </div>
                <div id="gachaResult" class="gacha-result"></div>
            </div>
        </div>
    </div>
    
    <!-- ÏòÅÏõÖ Í¥ÄÎ¶¨ Î™®Îã¨ -->
    <div id="heroManageModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('heroManageModal')">Îã´Í∏∞</button>
            <h2 class="modal-title">ÏòÅÏõÖ Í¥ÄÎ¶¨</h2>
            <div id="heroCollection"></div>
        </div>
    </div>
    
    <script>
        // Canvas ÏÑ§Ï†ï
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let CANVAS_WIDTH = window.innerWidth;
        let CANVAS_HEIGHT = window.innerHeight;
        let scaleRatio = 1;
        
        function clamp(min, val, max) {
            return Math.max(min, Math.min(val, max));
        }
        
        function resizeCanvas() {
            CANVAS_WIDTH = window.innerWidth;
            // ÏÑ∏Î°úÌòï Î™®Î∞îÏùº: ÏÉÅÎã® Ìó§ÎçîÏôÄ ÌïòÎã® Î∞îÎ•º Ï†úÏô∏Ìïú ÎÜíÏù¥
            const headerHeight = clamp(50, window.innerHeight * 0.08, 70);
            const bottomBarHeight = clamp(80, window.innerHeight * 0.12, 120);
            CANVAS_HEIGHT = window.innerHeight - headerHeight - bottomBarHeight;
            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
            scaleRatio = Math.min(CANVAS_WIDTH / 1200, CANVAS_HEIGHT / 800);
        }
        
        function adjustCanvasPosition() {
            const headerHeight = clamp(50, window.innerHeight * 0.08, 70);
            canvas.style.marginTop = `${headerHeight}px`;
            canvas.style.marginBottom = `${clamp(80, window.innerHeight * 0.12, 120)}px`;
        }
        
        resizeCanvas();
        adjustCanvasPosition();
        window.addEventListener('resize', () => {
            resizeCanvas();
            adjustCanvasPosition();
        });
        
        // Í≤åÏûÑ ÏÉÅÌÉú
        let gameState = 'PLAYING';
        let gold = 1000;
        let treasure = 10;
        let roundNum = 1;
        let enemies = [];
        let heroes = [];
        let placingHeroType = null;
        let selectedHero = null;
        let effects = [];
        
        // ÏòÅÏõÖ ÌÉÄÏûÖ Ï†ïÏùò
        const HeroType = {
            // Ï¥â(ËúÄ)
            LIUBEI: 0, GUANYU: 1, ZHANGFEI: 2, ZHAOYUN: 3, ZHUGELIANG: 4,
            HUANGZHONG: 5, MACHAO: 6, WEIYAN: 7, JIANGWEI: 8, GUANPING: 9,
            GUANXING: 10, ZHANGBao: 11, MA_DAI: 12,
            // ÏúÑ(È≠è)
            CAOCAO: 13, XIAHOUDUN: 14, ZHANGLIAO: 15, XUZHU: 16, XIAHOUYUAN: 17,
            XUHuang: 18, XUCHU: 19, YUJIN: 20, YUEJIN: 21, ZHANGHE: 22,
            WENCHOU: 23, YANLIANG: 24,
            // Ïò§(Âê≥)
            SUNQUAN: 25, ZHUYU: 26, GANNING: 27, TAISHICI: 28, LUMENG: 29,
            LUXUN: 30, SUNCE: 31, ZHOUTAI: 32, CHENGPU: 33, HUANGGAI: 34,
            // Í∏∞ÌÉÄ
            LUBU: 35
        };
        
        const HeroNames = [
            // Ï¥â(ËúÄ)
            'Ïú†ÎπÑ', 'Í¥ÄÏö∞', 'Ïû•ÎπÑ', 'Ï°∞Ïö¥', 'Ï†úÍ∞àÎüâ', 'Ìô©Ï∂©', 'ÎßàÏ¥à', 'ÏúÑÏó∞', 'Í∞ïÏú†', 'Í¥ÄÌèâ', 'Í¥ÄÌù•', 'Ïû•Ìè¨', 'ÎßàÎåÄ',
            // ÏúÑ(È≠è)
            'Ï°∞Ï°∞', 'ÌïòÌõÑÎèà', 'Ïû•Î£å', 'ÌóàÏ†Ä', 'ÌïòÌõÑÏó∞', 'ÏÑúÌô©', 'ÏïÖÏßÑ', 'Ïö∞Í∏à', 'Ïû•Ìï©', 'Î¨∏Ï∂î', 'ÏïàÎüâ',
            // Ïò§(Âê≥)
            'ÏÜêÍ∂å', 'Ï£ºÏú†', 'Í∞êÎÖï', 'ÌÉúÏÇ¨Ïûê', 'Ïó¨Î™Ω', 'Ïú°ÏÜê', 'ÏÜêÏ±Ö', 'Ï£ºÌÉú', 'Ï†ïÎ¥â', 'Ìô©Í∞ú',
            // Í∏∞ÌÉÄ
            'Ïó¨Ìè¨'
        ];
        
        const HeroGrade = {
            N: 'normal',
            R: 'rare',
            SR: 'sr',
            SSR: 'ssr'
        };
        
        const heroBaseGrade = {
            [HeroType.LIUBEI]: HeroGrade.R,
            [HeroType.GUANYU]: HeroGrade.SSR,
            [HeroType.ZHANGFEI]: HeroGrade.SR,
            [HeroType.ZHAOYUN]: HeroGrade.SR,
            [HeroType.ZHUGELIANG]: HeroGrade.SSR,
            [HeroType.HUANGZHONG]: HeroGrade.SR,
            [HeroType.MACHAO]: HeroGrade.SR,
            [HeroType.WEIYAN]: HeroGrade.R,
            [HeroType.JIANGWEI]: HeroGrade.SR,
            [HeroType.GUANPING]: HeroGrade.R,
            [HeroType.GUANXING]: HeroGrade.R,
            [HeroType.ZHANGBao]: HeroGrade.R,
            [HeroType.MA_DAI]: HeroGrade.R,
            [HeroType.CAOCAO]: HeroGrade.SSR,
            [HeroType.XIAHOUDUN]: HeroGrade.SR,
            [HeroType.ZHANGLIAO]: HeroGrade.SR,
            [HeroType.XUZHU]: HeroGrade.R,
            [HeroType.XIAHOUYUAN]: HeroGrade.SR,
            [HeroType.XUHuang]: HeroGrade.R,
            [HeroType.XUCHU]: HeroGrade.SR,
            [HeroType.YUJIN]: HeroGrade.R,
            [HeroType.YUEJIN]: HeroGrade.R,
            [HeroType.ZHANGHE]: HeroGrade.SR,
            [HeroType.WENCHOU]: HeroGrade.SR,
            [HeroType.YANLIANG]: HeroGrade.SR,
            [HeroType.SUNQUAN]: HeroGrade.SSR,
            [HeroType.ZHUYU]: HeroGrade.SSR,
            [HeroType.GANNING]: HeroGrade.SR,
            [HeroType.TAISHICI]: HeroGrade.SR,
            [HeroType.LUMENG]: HeroGrade.SR,
            [HeroType.LUXUN]: HeroGrade.SSR,
            [HeroType.SUNCE]: HeroGrade.SSR,
            [HeroType.ZHOUTAI]: HeroGrade.SR,
            [HeroType.CHENGPU]: HeroGrade.R,
            [HeroType.HUANGGAI]: HeroGrade.SR,
            [HeroType.LUBU]: HeroGrade.SSR
        };
        
        const heroCards = {};
        const heroStars = {};
        
        // Í∞ÄÏ±† ÌôïÎ•†
        const gachaRates = {
            normal: { N: 0.5, R: 0.35, SR: 0.13, SSR: 0.02 },
            premium: { N: 0.3, R: 0.4, SR: 0.25, SSR: 0.05 }
        };
        
        const heroesByGrade = {
            [HeroGrade.N]: [HeroType.LIUBEI, HeroType.WEIYAN, HeroType.XUHuang, HeroType.YUJIN, HeroType.YUEJIN, HeroType.GUANPING, HeroType.GUANXING, HeroType.ZHANGBao, HeroType.MA_DAI, HeroType.CHENGPU],
            [HeroGrade.R]: [HeroType.LIUBEI, HeroType.ZHANGFEI, HeroType.XUZHU, HeroType.WEIYAN, HeroType.XUHuang, HeroType.YUJIN, HeroType.YUEJIN, HeroType.GUANPING, HeroType.GUANXING, HeroType.ZHANGBao, HeroType.MA_DAI, HeroType.CHENGPU],
            [HeroGrade.SR]: [HeroType.ZHANGFEI, HeroType.ZHAOYUN, HeroType.XIAHOUDUN, HeroType.ZHANGLIAO, HeroType.HUANGZHONG, HeroType.MACHAO, HeroType.GANNING, HeroType.TAISHICI, HeroType.XIAHOUYUAN, HeroType.XUCHU, HeroType.ZHANGHE, HeroType.WENCHOU, HeroType.YANLIANG, HeroType.JIANGWEI, HeroType.LUMENG, HeroType.ZHOUTAI, HeroType.HUANGGAI],
            [HeroGrade.SSR]: [HeroType.GUANYU, HeroType.ZHUGELIANG, HeroType.LUBU, HeroType.CAOCAO, HeroType.SUNQUAN, HeroType.ZHUYU, HeroType.LUXUN, HeroType.SUNCE]
        };
        
        function getRandomHero(grade) {
            const availableHeroes = heroesByGrade[grade] || [HeroType.LIUBEI];
            return availableHeroes[Math.floor(Math.random() * availableHeroes.length)];
        }
        
        function addHeroCard(heroType, grade) {
            if (!heroCards[heroType]) {
                heroCards[heroType] = 0;
                heroStars[heroType] = 1;
            }
            heroCards[heroType]++;
            updateHeroSelection();
            updateHeroCollection();
        }
        
        function getTotalHeroCards(heroType) {
            return heroCards[heroType] || 0;
        }
        
        // Í∞ÄÏ±† Ìï®Ïàò
        function gachaSingle() {
            if (gold < 1000) {
                alert('Í∏àÌôîÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!');
                return;
            }
            gold -= 1000;
            const rand = Math.random();
            let grade = HeroGrade.N;
            if (rand < gachaRates.normal.SSR) grade = HeroGrade.SSR;
            else if (rand < gachaRates.normal.SSR + gachaRates.normal.SR) grade = HeroGrade.SR;
            else if (rand < gachaRates.normal.SSR + gachaRates.normal.SR + gachaRates.normal.R) grade = HeroGrade.R;
            
            const heroType = getRandomHero(grade);
            addHeroCard(heroType, grade);
            showGachaResult([{ type: heroType, grade: grade }]);
            updateUI();
        }
        
        function gachaMulti() {
            if (gold < 9000) {
                alert('Í∏àÌôîÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!');
                return;
            }
            gold -= 9000;
            const results = [];
            for (let i = 0; i < 10; i++) {
                const rand = Math.random();
                let grade = HeroGrade.N;
                if (rand < gachaRates.normal.SSR) grade = HeroGrade.SSR;
                else if (rand < gachaRates.normal.SSR + gachaRates.normal.SR) grade = HeroGrade.SR;
                else if (rand < gachaRates.normal.SSR + gachaRates.normal.SR + gachaRates.normal.R) grade = HeroGrade.R;
                
                const heroType = getRandomHero(grade);
                addHeroCard(heroType, grade);
                results.push({ type: heroType, grade: grade });
            }
            showGachaResult(results);
            updateUI();
        }
        
        function gachaSingleTreasure() {
            if (treasure < 10) {
                alert('Î≥¥Î¨ºÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§!');
                return;
            }
            treasure -= 10;
            const rand = Math.random();
            let grade = HeroGrade.R;
            if (rand < gachaRates.premium.SSR) grade = HeroGrade.SSR;
            else if (rand < gachaRates.premium.SSR + gachaRates.premium.SR) grade = HeroGrade.SR;
            
            const heroType = getRandomHero(grade);
            addHeroCard(heroType, grade);
            showGachaResult([{ type: heroType, grade: grade }]);
            updateUI();
        }
        
        function gachaMultiTreasure() {
            if (treasure < 90) {
                alert('Î≥¥Î¨ºÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§!');
                return;
            }
            treasure -= 90;
            const results = [];
            for (let i = 0; i < 10; i++) {
                const rand = Math.random();
                let grade = HeroGrade.R;
                if (rand < gachaRates.premium.SSR) grade = HeroGrade.SSR;
                else if (rand < gachaRates.premium.SSR + gachaRates.premium.SR) grade = HeroGrade.SR;
                
                const heroType = getRandomHero(grade);
                addHeroCard(heroType, grade);
                results.push({ type: heroType, grade: grade });
            }
            showGachaResult(results);
            updateUI();
        }
        
        function showGachaResult(results) {
            const resultDiv = document.getElementById('gachaResult');
            resultDiv.innerHTML = '';
            resultDiv.classList.add('show');
            
            results.forEach(result => {
                const card = document.createElement('div');
                card.className = `hero-card ${result.grade}`;
                card.innerHTML = `
                    <div style="font-size: clamp(12px, 2.5vw, 16px); font-weight: bold; margin-bottom: 5px;">${HeroNames[result.type]}</div>
                    <div style="font-size: clamp(10px, 2vw, 14px); color: #ccc;">${result.grade.toUpperCase()}</div>
                `;
                resultDiv.appendChild(card);
            });
        }
        
        function updateUI() {
            document.getElementById('goldAmount').textContent = gold;
            document.getElementById('treasureAmount').textContent = treasure;
            document.getElementById('roundNumber').textContent = roundNum;
        }
        
        function updateHeroSelection() {
            const selectionDiv = document.getElementById('heroSelection');
            selectionDiv.innerHTML = '';
            
            Object.keys(heroCards).forEach(heroType => {
                const totalCards = getTotalHeroCards(parseInt(heroType));
                if (totalCards > 0) {
                    const btn = document.createElement('button');
                    btn.className = 'hero-btn';
                    const type = parseInt(heroType);
                    const grade = heroBaseGrade[type];
                    
                    // Îì±Í∏âÎ≥Ñ ÏÉâÏÉÅ
                    let borderColor = '#fff';
                    if (grade === HeroGrade.SSR) borderColor = '#ffd700';
                    else if (grade === HeroGrade.SR) borderColor = '#9370db';
                    else if (grade === HeroGrade.R) borderColor = '#4169e1';
                    
                    btn.style.borderColor = borderColor;
                    
                    btn.innerHTML = `
                        <div class="hero-btn-name">${HeroNames[type].substring(0, 2)}</div>
                        <div class="hero-btn-count">${totalCards}</div>
                    `;
                    
                    btn.onclick = () => {
                        if (placingHeroType === type) {
                            placingHeroType = null;
                            document.querySelectorAll('.hero-btn').forEach(b => b.classList.remove('selected'));
                        } else {
                            placingHeroType = type;
                            document.querySelectorAll('.hero-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                        }
                    };
                    selectionDiv.appendChild(btn);
                }
            });
        }
        
        function updateHeroCollection() {
            const collectionDiv = document.getElementById('heroCollection');
            collectionDiv.innerHTML = '';
            
            Object.keys(heroCards).forEach(heroType => {
                const type = parseInt(heroType);
                const totalCards = getTotalHeroCards(type);
                const stars = heroStars[type] || 1;
                const grade = heroBaseGrade[type];
                
                const card = document.createElement('div');
                card.className = `hero-card ${grade}`;
                card.innerHTML = `
                    <div style="font-size: clamp(14px, 3vw, 18px); font-weight: bold; margin-bottom: 8px;">${HeroNames[type]}</div>
                    <div style="font-size: clamp(10px, 2vw, 12px); color: #ccc; margin-bottom: 5px;">${grade.toUpperCase()}</div>
                    <div style="font-size: clamp(12px, 2.5vw, 16px); color: #ffd700;">‚òÖ${stars}</div>
                    <div style="font-size: clamp(10px, 2vw, 12px); margin-top: 5px;">Î≥¥Ïú†: ${totalCards}Í∞ú</div>
                `;
                collectionDiv.appendChild(card);
            });
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        document.getElementById('shopButton').addEventListener('click', () => {
            document.getElementById('shopModal').classList.add('show');
        });
        
        document.getElementById('heroManageButton').addEventListener('click', () => {
            document.getElementById('heroManageModal').classList.add('show');
        });
        
        // Hero ÌÅ¥ÎûòÏä§
        class Hero {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.stars = heroStars[type] || 1;
                this.health = 500 + (this.stars - 1) * 100;
                this.maxHealth = this.health;
                this.attack = 50 + (this.stars - 1) * 10;
                this.range = 150;
                this.attackSpeed = 1.0;
                this.target = null;
                this.lastAttackTime = 0;
            }
            
            update(dt, enemies) {
                this.findTarget(enemies);
                if (this.target && this.target.alive) {
                    const currentTime = Date.now() / 1000;
                    if (currentTime - this.lastAttackTime >= 1.0 / this.attackSpeed) {
                        this.attackTarget();
                        this.lastAttackTime = currentTime;
                    }
                }
            }
            
            findTarget(enemies) {
                let closestEnemy = null;
                let closestDist = Infinity;
                
                for (const enemy of enemies) {
                    if (!enemy.alive) continue;
                    const dist = Math.sqrt((enemy.x - this.x) ** 2 + (enemy.y - this.y) ** 2);
                    if (dist <= this.range && dist < closestDist) {
                        closestEnemy = enemy;
                        closestDist = dist;
                    }
                }
                
                this.target = closestEnemy;
            }
            
            attackTarget() {
                if (this.target && this.target.alive) {
                    this.target.takeDamage(this.attack);
                }
            }
            
            draw() {
                const size = 20 * scaleRatio;
                ctx.fillStyle = '#228b22';
                ctx.beginPath();
                ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#fff';
                ctx.font = `${12 * scaleRatio}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(HeroNames[this.type].substring(0, 2), this.x, this.y + size + 15 * scaleRatio);
                
                // Ï≤¥Î†•Î∞î
                const barWidth = size * 2;
                const barHeight = 4 * scaleRatio;
                ctx.fillStyle = '#000';
                ctx.fillRect(this.x - barWidth / 2, this.y - size - 10 * scaleRatio, barWidth, barHeight);
                ctx.fillStyle = '#0f0';
                ctx.fillRect(this.x - barWidth / 2, this.y - size - 10 * scaleRatio, barWidth * (this.health / this.maxHealth), barHeight);
            }
        }
        
        // Enemy ÌÅ¥ÎûòÏä§
        class Enemy {
            constructor() {
                this.path = this.generatePath();
                this.pathIndex = 0;
                this.x = this.path[0].x;
                this.y = this.path[0].y;
                this.health = 100;
                this.maxHealth = 100;
                this.speed = 50 * scaleRatio;
                this.alive = true;
            }
            
            generatePath() {
                return [
                    { x: 0, y: CANVAS_HEIGHT / 2 },
                    { x: CANVAS_WIDTH / 3, y: CANVAS_HEIGHT / 2 },
                    { x: CANVAS_WIDTH / 2, y: CANVAS_HEIGHT / 3 },
                    { x: CANVAS_WIDTH * 2 / 3, y: CANVAS_HEIGHT / 3 },
                    { x: CANVAS_WIDTH, y: CANVAS_HEIGHT / 2 }
                ];
            }
            
            update(dt) {
                if (this.pathIndex >= this.path.length - 1) {
                    this.alive = false;
                    return;
                }
                
                const target = this.path[this.pathIndex + 1];
                const dx = target.x - this.x;
                const dy = target.y - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < this.speed * dt) {
                    this.pathIndex++;
                    if (this.pathIndex >= this.path.length - 1) {
                        this.alive = false;
                        return;
                    }
                } else {
                    this.x += (dx / dist) * this.speed * dt;
                    this.y += (dy / dist) * this.speed * dt;
                }
            }
            
            takeDamage(damage) {
                this.health -= damage;
                if (this.health <= 0) {
                    this.alive = false;
                    gold += 10;
                    updateUI();
                    return true;
                }
                return false;
            }
            
            draw() {
                const size = 15 * scaleRatio;
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                ctx.fill();
                
                // Ï≤¥Î†•Î∞î
                const barWidth = size * 2;
                const barHeight = 3 * scaleRatio;
                ctx.fillStyle = '#000';
                ctx.fillRect(this.x - barWidth / 2, this.y - size - 8 * scaleRatio, barWidth, barHeight);
                ctx.fillStyle = '#f00';
                ctx.fillRect(this.x - barWidth / 2, this.y - size - 8 * scaleRatio, barWidth * (this.health / this.maxHealth), barHeight);
            }
        }
        
        // Í≤ΩÎ°ú Í∑∏Î¶¨Í∏∞
        function drawPath() {
            const pathPoints = [
                { x: 0, y: CANVAS_HEIGHT / 2 },
                { x: CANVAS_WIDTH / 3, y: CANVAS_HEIGHT / 2 },
                { x: CANVAS_WIDTH / 2, y: CANVAS_HEIGHT / 3 },
                { x: CANVAS_WIDTH * 2 / 3, y: CANVAS_HEIGHT / 3 },
                { x: CANVAS_WIDTH, y: CANVAS_HEIGHT / 2 }
            ];
            
            ctx.strokeStyle = '#646464';
            ctx.lineWidth = Math.max(3, CANVAS_WIDTH / 240);
            ctx.beginPath();
            ctx.moveTo(pathPoints[0].x, pathPoints[0].y);
            for (let i = 1; i < pathPoints.length; i++) {
                ctx.lineTo(pathPoints[i].x, pathPoints[i].y);
            }
            ctx.stroke();
        }
        
        // Í≤ΩÎ°ú ÏúÑÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
        function isOnPath(x, y, pathWidth = 40) {
            const pathPoints = [
                { x: 0, y: CANVAS_HEIGHT / 2 },
                { x: CANVAS_WIDTH / 3, y: CANVAS_HEIGHT / 2 },
                { x: CANVAS_WIDTH / 2, y: CANVAS_HEIGHT / 3 },
                { x: CANVAS_WIDTH * 2 / 3, y: CANVAS_HEIGHT / 3 },
                { x: CANVAS_WIDTH, y: CANVAS_HEIGHT / 2 }
            ];
            
            for (let i = 0; i < pathPoints.length - 1; i++) {
                const p1 = pathPoints[i];
                const p2 = pathPoints[i + 1];
                const A = x - p1.x;
                const B = y - p1.y;
                const C = p2.x - p1.x;
                const D = p2.y - p1.y;
                const dot = A * C + B * D;
                const lenSq = C * C + D * D;
                let param = lenSq !== 0 ? dot / lenSq : -1;
                
                let xx, yy;
                if (param < 0) {
                    xx = p1.x;
                    yy = p1.y;
                } else if (param > 1) {
                    xx = p2.x;
                    yy = p2.y;
                } else {
                    xx = p1.x + param * C;
                    yy = p1.y + param * D;
                }
                
                const dx = x - xx;
                const dy = y - yy;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < pathWidth) {
                    return true;
                }
            }
            
            return false;
        }
        
        let waveTimer = 0;
        const waveInterval = 3;
        
        function spawnEnemy() {
            enemies.push(new Enemy());
        }
        
        function startRound() {
            waveTimer = 0;
            for (let i = 0; i < 5; i++) {
                setTimeout(() => spawnEnemy(), i * 1000);
            }
        }
        
        // Í≤åÏûÑ ÏóÖÎç∞Ïù¥Ìä∏
        function update(dt) {
            // Ï†Å ÏóÖÎç∞Ïù¥Ìä∏
            for (let i = enemies.length - 1; i >= 0; i--) {
                enemies[i].update(dt);
                if (!enemies[i].alive) {
                    enemies.splice(i, 1);
                }
            }
            
            // ÏòÅÏõÖ ÏóÖÎç∞Ïù¥Ìä∏
            for (const hero of heroes) {
                hero.update(dt, enemies);
            }
            
            // Ïõ®Ïù¥Î∏å ÏÉùÏÑ±
            waveTimer += dt;
            if (waveTimer >= waveInterval) {
                spawnEnemy();
                waveTimer = 0;
            }
        }
        
        // Í≤åÏûÑ Í∑∏Î¶¨Í∏∞
        function draw() {
            ctx.fillStyle = '#0f3460';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            drawPath();
            
            for (const hero of heroes) {
                hero.draw();
            }
            
            for (const enemy of enemies) {
                enemy.draw();
            }
        }
        
        // ÌÑ∞Ïπò/ÌÅ¥Î¶≠ Ï¢åÌëú Î≥ÄÌôò
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else if (e.changedTouches && e.changedTouches.length > 0) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const scaleX = CANVAS_WIDTH / rect.width;
            const scaleY = CANVAS_HEIGHT / rect.height;
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }
        
        // ÌÅ¥Î¶≠/ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏
        canvas.addEventListener('click', (e) => {
            if (gameState !== 'PLAYING') return;
            
            const coords = getCanvasCoordinates(e);
            const x = coords.x;
            const y = coords.y;
            
            if (placingHeroType !== null) {
                // Í∞ôÏùÄ ÌÉÄÏûÖÏùò ÏòÅÏõÖÏù¥ Ïù¥ÎØ∏ Î∞∞ÏπòÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                const existingHero = heroes.find(h => h.type === placingHeroType);
                if (existingHero) {
                    alert(`${HeroNames[placingHeroType]}ÏùÄ(Îäî) Ïù¥ÎØ∏ Î∞∞ÏπòÎêòÏñ¥ ÏûàÏäµÎãàÎã§!`);
                    return;
                }
                
                // Í≤ΩÎ°ú ÏúÑÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
                if (isOnPath(x, y)) {
                    alert('Î™¨Ïä§ÌÑ∞Í∞Ä ÏßÄÎÇòÍ∞ÄÎäî Í∏∏ ÏúÑÏóêÎäî ÏòÅÏõÖÏùÑ Î∞∞ÏπòÌï† Ïàò ÏóÜÏäµÎãàÎã§!');
                    return;
                }
                
                // Îã§Î•∏ ÏòÅÏõÖÍ≥º Í≤πÏπòÎäîÏßÄ ÌôïÏù∏
                const minDistance = 50;
                for (const hero of heroes) {
                    const dist = Math.sqrt((hero.x - x) ** 2 + (hero.y - y) ** 2);
                    if (dist < minDistance) {
                        alert('Îã§Î•∏ ÏòÅÏõÖÍ≥º ÎÑàÎ¨¥ Í∞ÄÍπùÏäµÎãàÎã§!');
                        return;
                    }
                }
                
                const totalCards = getTotalHeroCards(placingHeroType);
                if (totalCards === 0) {
                    alert('ÏòÅÏõÖ Ïπ¥ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§!');
                    return;
                }
                
                const hero = new Hero(x, y, placingHeroType);
                heroes.push(hero);
                placingHeroType = null;
                document.querySelectorAll('.hero-btn').forEach(btn => btn.classList.remove('selected'));
            } else {
                for (const hero of heroes) {
                    const dist = Math.sqrt((hero.x - x) ** 2 + (hero.y - y) ** 2);
                    if (dist < 20) {
                        selectedHero = hero;
                        break;
                    }
                }
            }
        });
        
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState !== 'PLAYING') return;
            
            const coords = getCanvasCoordinates(e);
            const x = coords.x;
            const y = coords.y;
            
            if (placingHeroType !== null) {
                const existingHero = heroes.find(h => h.type === placingHeroType);
                if (existingHero) {
                    alert(`${HeroNames[placingHeroType]}ÏùÄ(Îäî) Ïù¥ÎØ∏ Î∞∞ÏπòÎêòÏñ¥ ÏûàÏäµÎãàÎã§!`);
                    return;
                }
                
                if (isOnPath(x, y)) {
                    alert('Î™¨Ïä§ÌÑ∞Í∞Ä ÏßÄÎÇòÍ∞ÄÎäî Í∏∏ ÏúÑÏóêÎäî ÏòÅÏõÖÏùÑ Î∞∞ÏπòÌï† Ïàò ÏóÜÏäµÎãàÎã§!');
                    return;
                }
                
                const minDistance = 50;
                for (const hero of heroes) {
                    const dist = Math.sqrt((hero.x - x) ** 2 + (hero.y - y) ** 2);
                    if (dist < minDistance) {
                        alert('Îã§Î•∏ ÏòÅÏõÖÍ≥º ÎÑàÎ¨¥ Í∞ÄÍπùÏäµÎãàÎã§!');
                        return;
                    }
                }
                
                const totalCards = getTotalHeroCards(placingHeroType);
                if (totalCards === 0) {
                    alert('ÏòÅÏõÖ Ïπ¥ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§!');
                    return;
                }
                
                const hero = new Hero(x, y, placingHeroType);
                heroes.push(hero);
                placingHeroType = null;
                document.querySelectorAll('.hero-btn').forEach(btn => btn.classList.remove('selected'));
            } else {
                for (const hero of heroes) {
                    const dist = Math.sqrt((hero.x - x) ** 2 + (hero.y - y) ** 2);
                    if (dist < 20) {
                        selectedHero = hero;
                        break;
                    }
                }
            }
        }, { passive: false });
        
        // Î™®Î∞îÏùº Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ
        document.addEventListener('touchmove', (e) => {
            if (e.target === canvas || e.target.closest('#gameContainer')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Ï¥àÍ∏∞ ÏòÅÏõÖ Ïπ¥Îìú ÏßÄÍ∏â
        addHeroCard(HeroType.LIUBEI, HeroGrade.R);
        addHeroCard(HeroType.ZHANGFEI, HeroGrade.SR);
        addHeroCard(HeroType.XUZHU, HeroGrade.R);
        addHeroCard(HeroType.XIAHOUDUN, HeroGrade.SR);
        addHeroCard(HeroType.WEIYAN, HeroGrade.R);
        addHeroCard(HeroType.HUANGZHONG, HeroGrade.SR);
        addHeroCard(HeroType.CHENGPU, HeroGrade.R);
        addHeroCard(HeroType.GANNING, HeroGrade.SR);
        
        updateUI();
        startRound();
        
        // Í≤åÏûÑ Î£®ÌîÑ
        let lastTime = 0;
        function gameLoop(currentTime) {
            const dt = Math.min((currentTime - lastTime) / 1000, 0.1);
            lastTime = currentTime;
            
            update(dt);
            draw();
            
            requestAnimationFrame(gameLoop);
        }
        
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>


